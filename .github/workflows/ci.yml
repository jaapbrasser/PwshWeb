name: CI

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        pwsh-version: ['7.4.6', '7.5.0']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PowerShell
      uses: PSModule/install-powershell@v1
      with:
        Version: ${{ matrix.pwsh-version }}

    - name: Verify PowerShell Version
      shell: pwsh
      run: |
        Write-Host "Using PowerShell $($PSVersionTable.PSVersion)"
        Write-Host "OS: $([System.Environment]::OSVersion.Platform)"

    - name: Install Pester
      shell: pwsh
      run: |
        Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0
        Import-Module Pester -MinimumVersion 5.0
        Write-Host "Pester version: $((Get-Module Pester).Version)"

    - name: Run Pester Tests
      shell: pwsh
      run: |
        $config = New-PesterConfiguration
        $config.Run.Path = './Tests/PwshWeb.Tests.ps1'
        $config.TestResult.Enabled = $true
        $config.TestResult.OutputPath = 'test-results.xml'
        $config.TestResult.OutputFormat = 'JUnitXml'
        $config.Output.Verbosity = 'Detailed'
        Invoke-Pester -Configuration $config

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-pwsh${{ matrix.pwsh-version }}
        path: test-results.xml

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: |
        always() &&
        (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
      with:
        name: Pester Tests - ${{ matrix.os }} - PowerShell ${{ matrix.pwsh-version }}
        path: test-results.xml
        reporter: java-junit
        fail-on-error: true
