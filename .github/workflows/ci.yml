name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        pwsh-version: ['7.4', 'latest']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PowerShell
      uses: actions/setup-powershell@v1
      with:
        powershell-version: ${{ matrix.pwsh-version }}

    - name: Install Pester
      shell: pwsh
      run: |
        Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0
        Import-Module Pester -MinimumVersion 5.0

    - name: Run Pester Tests
      shell: pwsh
      run: |
        $config = New-PesterConfiguration
        $config.Run.Path = './Tests/PwshWeb.Tests.ps1'
        $config.TestResult.Enabled = $true
        $config.TestResult.OutputPath = 'test-results.xml'
        $config.Output.Verbosity = 'Detailed'
        Invoke-Pester -Configuration $config

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-pwsh${{ matrix.pwsh-version }}
        path: test-results.xml

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Pester Tests - ${{ matrix.os }} - PowerShell ${{ matrix.pwsh-version }}
        path: test-results.xml
        reporter: java-junit
        fail-on-error: true